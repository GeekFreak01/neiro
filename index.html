<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donation & Subscription Widget</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: transparent;
            overflow: hidden;
        }

        .widget-container {
            width: 400px;
            height: 80px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            display: flex;
            align-items: center;
            padding: 15px 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        .event-item {
            display: flex;
            align-items: center;
            gap: 15px;
            width: 100%;
            opacity: 0;
            animation: fadeInOut 6s ease-in-out;
            position: absolute;
            left: 20px;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(20px); }
            15% { opacity: 1; transform: translateY(0); }
            85% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }

        .icon-container {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .icon {
            width: 30px;
            height: 30px;
            fill: #ffffff;
        }

        .event-info {
            flex: 1;
            color: #ffffff;
        }

        .event-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .event-detail {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
        }

        .donation-amount {
            color: #4ade80;
            font-weight: bold;
        }

        .subscription-months {
            color: #a78bfa;
            font-weight: bold;
        }

        .money-icon {
            width: 30px;
            height: 30px;
        }

        .subscriber-icon {
            width: 30px;
            height: 30px;
        }

        /* Конфигурационная форма */
        .config-form {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border-radius: 15px;
            color: white;
            max-width: 500px;
            width: 90%;
        }

        .config-form h2 {
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
        }

        .form-group input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .save-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 5px;
            background: #4ade80;
            color: black;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }

        .save-btn:hover {
            background: #22c55e;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Форма конфигурации -->
    <div id="configForm" class="config-form">
        <h2>Настройка виджета</h2>
        <div class="form-group">
            <label>DonationAlerts API Token:</label>
            <input type="text" id="daToken" placeholder="Введите токен DonationAlerts">
        </div>
        <div class="form-group">
            <label>Twitch Client ID:</label>
            <input type="text" id="twitchClientId" placeholder="Введите Twitch Client ID">
        </div>
        <div class="form-group">
            <label>Twitch Access Token:</label>
            <input type="text" id="twitchAccessToken" placeholder="Введите Twitch Access Token">
        </div>
        <div class="form-group">
            <label>Twitch Channel Name:</label>
            <input type="text" id="twitchChannel" placeholder="Введите имя канала Twitch">
        </div>
        <button class="save-btn" onclick="saveConfig()">Сохранить и запустить</button>
    </div>

    <!-- Виджет -->
    <div id="widget" class="widget-container hidden">
        <div id="eventDisplay" class="event-item">
            <!-- События будут отображаться здесь -->
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/centrifuge@2.8.4/dist/centrifuge.min.js"></script>
    <script>
        // Конфигурация
        let CONFIG = {
            donationAlertsToken: '',
            twitchClientId: '',
            twitchAccessToken: '',
            twitchChannel: '',
            displayDuration: 6000,
            minDonationAmount: 1,
        };

        // Проверка параметров URL
        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const daToken = urlParams.get('da_token');
            const twitchClientId = urlParams.get('twitch_client_id');
            const twitchAccessToken = urlParams.get('twitch_access_token');
            const twitchChannel = urlParams.get('twitch_channel');

            if (daToken && twitchClientId && twitchAccessToken && twitchChannel) {
                CONFIG.donationAlertsToken = daToken;
                CONFIG.twitchClientId = twitchClientId;
                CONFIG.twitchAccessToken = twitchAccessToken;
                CONFIG.twitchChannel = twitchChannel;
                
                document.getElementById('configForm').classList.add('hidden');
                document.getElementById('widget').classList.remove('hidden');
                init();
                return true;
            }
            return false;
        }

        // Сохранение конфигурации
        function saveConfig() {
            const daToken = document.getElementById('daToken').value;
            const twitchClientId = document.getElementById('twitchClientId').value;
            const twitchAccessToken = document.getElementById('twitchAccessToken').value;
            const twitchChannel = document.getElementById('twitchChannel').value;

            if (!daToken || !twitchClientId || !twitchAccessToken || !twitchChannel) {
                alert('Пожалуйста, заполните все поля');
                return;
            }

            // Создаем URL с параметрами
            const params = new URLSearchParams({
                da_token: daToken,
                twitch_client_id: twitchClientId,
                twitch_access_token: twitchAccessToken,
                twitch_channel: twitchChannel
            });

            // Перезагружаем страницу с параметрами
            window.location.href = window.location.pathname + '?' + params.toString();
        }

        // Очередь событий
        let eventQueue = [];
        let isDisplaying = false;

        // SVG иконки
        const icons = {
            money: `<svg class="money-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1.93.66 1.64 2.08 1.64 1.51 0 1.86-.79 1.86-1.28 0-.54-.2-1.13-1.64-1.45-2.06-.45-3.45-1.17-3.45-3.05 0-1.64 1.28-2.94 3.11-3.28V6h2.67v1.26c1.65.38 2.81 1.53 2.94 3.14h-1.96c-.13-.87-.57-1.46-1.68-1.46-1.17 0-1.64.64-1.64 1.17 0 .58.35.98 1.53 1.23 2.08.47 3.57 1.22 3.57 3.16 0 1.7-1.17 3.05-3.35 3.41z"/>
            </svg>`,
            subscriber: `<svg class="subscriber-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
                <path d="M16 1l1.26 2.75L20 5l-2 2.29L18 10l-2.74-1.25L13 10l.29-2.71L11 5l2.76-1.25z" fill="#fbbf24"/>
            </svg>`
        };

        // Добавление события в очередь
        function addEvent(type, data) {
            eventQueue.push({ type, data, timestamp: Date.now() });
            if (!isDisplaying) {
                displayNextEvent();
            }
        }

        // Отображение следующего события
        function displayNextEvent() {
            if (eventQueue.length === 0) {
                isDisplaying = false;
                return;
            }

            isDisplaying = true;
            const event = eventQueue.shift();
            const eventDisplay = document.getElementById('eventDisplay');

            let html = '';
            if (event.type === 'donation') {
                html = `
                    <div class="icon-container">
                        ${icons.money}
                    </div>
                    <div class="event-info">
                        <div class="event-name">${event.data.username}</div>
                        <div class="event-detail">
                            Донат: <span class="donation-amount">${event.data.amount} ${event.data.currency}</span>
                        </div>
                    </div>
                `;
            } else if (event.type === 'subscription') {
                html = `
                    <div class="icon-container">
                        ${icons.subscriber}
                    </div>
                    <div class="event-info">
                        <div class="event-name">${event.data.username}</div>
                        <div class="event-detail">
                            Подписка: <span class="subscription-months">${event.data.months} ${getMonthsText(event.data.months)}</span>
                        </div>
                    </div>
                `;
            }

            eventDisplay.innerHTML = html;
            eventDisplay.style.opacity = '0';
            eventDisplay.style.animation = 'none';
            
            eventDisplay.offsetHeight;
            
            eventDisplay.style.animation = 'fadeInOut 6s ease-in-out';

            setTimeout(() => {
                displayNextEvent();
            }, CONFIG.displayDuration);
        }

        // Склонение слова "месяц"
        function getMonthsText(months) {
            const lastDigit = months % 10;
            const lastTwoDigits = months % 100;
            
            if (lastTwoDigits >= 11 && lastTwoDigits <= 14) {
                return 'месяцев';
            }
            
            if (lastDigit === 1) {
                return 'месяц';
            } else if (lastDigit >= 2 && lastDigit <= 4) {
                return 'месяца';
            } else {
                return 'месяцев';
            }
        }

        // Подключение к DonationAlerts
        function connectDonationAlerts() {
            // Получаем информацию о пользователе для socket token
            fetch(`https://www.donationalerts.com/api/v1/user/oauth`, {
                headers: {
                    'Authorization': `Bearer ${CONFIG.donationAlertsToken}`
                }
            })
            .then(response => response.json())
            .then(data => {
                const userId = data.data.id;
                const socketToken = data.data.socket_connection_token;
                
                // Подключаемся к WebSocket
                const centrifuge = new Centrifuge('wss://centrifugo.donationalerts.com/connection/websocket', {
                    token: socketToken
                });

                centrifuge.on('connect', function(ctx) {
                    console.log('Connected to DonationAlerts WebSocket');
                });

                // Подписываемся на события донатов
                const sub = centrifuge.subscribe(`$alerts:donation_${userId}`, function(message) {
                    console.log('New donation:', message);
                    if (message.data.amount >= CONFIG.minDonationAmount) {
                        addEvent('donation', {
                            username: message.data.username,
                            amount: message.data.amount,
                            currency: message.data.currency
                        });
                    }
                });

                centrifuge.connect();
            })
            .catch(error => {
                console.error('Error connecting to DonationAlerts:', error);
            });
        }

        // Получение ID канала Twitch
        async function getTwitchUserId() {
            try {
                const response = await fetch(`https://api.twitch.tv/helix/users?login=${CONFIG.twitchChannel}`, {
                    headers: {
                        'Client-ID': CONFIG.twitchClientId,
                        'Authorization': `Bearer ${CONFIG.twitchAccessToken}`
                    }
                });
                const data = await response.json();
                return data.data[0].id;
            } catch (error) {
                console.error('Error getting Twitch user ID:', error);
                return null;
            }
        }

        // Подключение к Twitch через EventSub
        async function connectTwitchEventSub() {
            const userId = await getTwitchUserId();
            if (!userId) {
                console.error('Failed to get Twitch user ID');
                return;
            }

            // Для WebSocket подключения нужен специальный сервер
            // В браузере напрямую подключиться к Twitch EventSub WebSocket нельзя
            // Используем polling метод для получения последних подписчиков
            
            console.log('Twitch monitoring started for channel:', CONFIG.twitchChannel);
            
            // Проверяем новых подписчиков каждые 30 секунд
            setInterval(async () => {
                try {
                    const response = await fetch(`https://api.twitch.tv/helix/subscriptions?broadcaster_id=${userId}&first=5`, {
                        headers: {
                            'Client-ID': CONFIG.twitchClientId,
                            'Authorization': `Bearer ${CONFIG.twitchAccessToken}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        // Обработка подписок
                        console.log('Subscriptions check:', data);
                    }
                } catch (error) {
                    console.error('Error checking subscriptions:', error);
                }
            }, 30000);
        }

        // Тестовые данные
        function addTestEvents() {
            setTimeout(() => {
                addEvent('donation', {
                    username: 'TestUser1',
                    amount: 100,
                    currency: 'RUB'
                });
            }, 1000);

            setTimeout(() => {
                addEvent('subscription', {
                    username: 'TestSubscriber',
                    months: 3
                });
            }, 8000);

            setTimeout(() => {
                addEvent('donation', {
                    username: 'BigDonator',
                    amount: 500,
                    currency: 'RUB'
                });
            }, 15000);

            setTimeout(() => {
                addEvent('subscription', {
                    username: 'LoyalViewer',
                    months: 12
                });
            }, 22000);
        }

        // Инициализация
        function init() {
            // Подключение к сервисам
            connectDonationAlerts();
            connectTwitchEventSub();

            // Добавляем тестовые события
            addTestEvents();
            
            // Повторяем тестовые события каждые 30 секунд
            setInterval(addTestEvents, 30000);
        }

        // Проверяем параметры при загрузке
        document.addEventListener('DOMContentLoaded', () => {
            if (!checkUrlParams()) {
                // Показываем форму конфигурации
                document.getElementById('configForm').classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
