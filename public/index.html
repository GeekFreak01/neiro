<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DonationAlerts Auto Widget</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@900&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: transparent;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }

        .setup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-family: 'Inter', sans-serif;
        }

        .setup-form {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
        }

        .setup-form h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        .setup-form input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            box-sizing: border-box;
        }

        .setup-form input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .setup-form button {
            width: 100%;
            padding: 12px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 0;
        }

        .setup-form button:hover {
            background: #45a049;
        }

        .widget {
            width: 320px;
            height: 50px;
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 4px 4px 0 rgba(68, 0, 102, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 1;
        }

        .content {
            display: flex;
            align-items: center;
            font-size: 14px;
            font-weight: 900;
            white-space: nowrap;
            transition: opacity 0.3s ease;
        }

        .icon {
            margin-right: 8px;
            font-size: 20px;
            color: #440066;
        }

        .text {
            color: #000;
            max-width: 260px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
        }

        .status.success {
            background: rgba(76, 175, 80, 0.8);
        }

        .status.error {
            background: rgba(244, 67, 54, 0.8);
        }

        .hidden {
            display: none;
        }

        .info {
            background: rgba(33, 150, 243, 0.1);
            border: 1px solid rgba(33, 150, 243, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 14px;
        }

        .test-btn {
            background: #FF9800;
        }

        .test-btn:hover {
            background: #F57C00;
        }
    </style>
</head>
<body>
    <div id="setup" class="setup">
        <div class="setup-form">
            <h2>üéØ –ü—Ä–æ—Å—Ç–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∏–¥–∂–µ—Ç–∞</h2>
            
            <div class="info">
                <strong>–ß—Ç–æ –Ω—É–∂–Ω–æ:</strong><br>
                1. –í–∞—à —Ç–æ–∫–µ–Ω DonationAlerts<br>
                2. –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω–æ–µ —Å–¥–µ–ª–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
            </div>

            <input type="password" id="token" placeholder="DonationAlerts Access Token">
            
            <button onclick="startWidget()">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
            <button class="test-btn" onclick="testMode()">üß™ –¢–µ—Å—Ç (–±–µ–∑ API)</button>
            
            <div class="info">
                <strong>–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω:</strong><br>
                1. –ó–∞–π–¥–∏—Ç–µ –Ω–∞ donationalerts.com<br>
                2. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí API ‚Üí –°–æ–∑–¥–∞—Ç—å —Ç–æ–∫–µ–Ω<br>
                3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–æ–∫–µ–Ω —Å—é–¥–∞
            </div>
        </div>
    </div>

    <div id="widget" class="widget hidden">
        <div class="content" id="content">
            <div class="icon">üí∞</div>
            <div class="text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </div>

    <div id="status" class="status hidden"></div>

    <script>
        let token = '';
        let items = [];
        let currentIndex = 0;
        let intervalId = null;
        let checkInterval = null;
        let isTestMode = false;

        // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –∏–∑ URL –µ—Å–ª–∏ –µ—Å—Ç—å
        const urlParams = new URLSearchParams(window.location.search);
        const urlToken = urlParams.get('token');
        if (urlToken) {
            token = urlToken;
            document.getElementById('setup').style.display = 'none';
            document.getElementById('widget').classList.remove('hidden');
            startDataFetching();
        }

        function startWidget() {
            token = document.getElementById('token').value.trim();
            
            if (!token) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω!');
                return;
            }
            
            document.getElementById('setup').style.display = 'none';
            document.getElementById('widget').classList.remove('hidden');
            document.getElementById('status').classList.remove('hidden');
            
            console.log('üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –≤–∏–¥–∂–µ—Ç —Å —Ç–æ–∫–µ–Ω–æ–º –¥–ª–∏–Ω–æ–π:', token.length);
            startDataFetching();
        }

        function testMode() {
            isTestMode = true;
            document.getElementById('setup').style.display = 'none';
            document.getElementById('widget').classList.remove('hidden');
            document.getElementById('status').classList.remove('hidden');
            
            console.log('üß™ –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');
            showStatus('üß™ –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º', 'success');
            
            // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
            items = [
                { icon: 'üí∞', text: '–ê–ª–µ–∫—Å–µ–π ‚Äî 500 RUB' },
                { icon: 'üí∞', text: 'TestUser ‚Äî 100 RUB' },
                { icon: 'üí∞', text: '–î–æ–Ω–∞—Ç–µ—Ä ‚Äî 1000 RUB' },
                { icon: 'üí∞', text: 'Supporter ‚Äî 250 USD' },
                { icon: 'üí∞', text: '–ë–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å ‚Äî 300 EUR' }
            ];
            
            startRotation();
        }

        async function startDataFetching() {
            showStatus('üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ API...', '');
            
            try {
                await fetchDonations();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
                checkInterval = setInterval(fetchDonations, 30000);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞:', error);
                showStatus('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'error');
            }
        }

        async function fetchDonations() {
            if (isTestMode) return;
            
            try {
                console.log('üì° –ó–∞–ø—Ä–æ—Å –∫ DonationAlerts API...');
                
                const response = await fetch('https://www.donationalerts.com/api/v1/alerts/donations', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json'
                    }
                });

                console.log('üìä –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', response.status);

                if (response.status === 401) {
                    showStatus('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω', 'error');
                    return;
                }

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                console.log('üì¶ –ü–æ–ª—É—á–µ–Ω–æ –¥–æ–Ω–∞—Ç–æ–≤:', data.data?.length);

                if (data.data && data.data.length > 0) {
                    processData(data.data);
                    showStatus(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${items.length} –¥–æ–Ω–∞—Ç–æ–≤`, 'success');
                } else {
                    items = [{ icon: '‚è≥', text: '–ù–µ—Ç –Ω–æ–≤—ã—Ö –¥–æ–Ω–∞—Ç–æ–≤' }];
                    showStatus('‚è≥ –î–æ–Ω–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', '');
                    startRotation();
                }

            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ API:', error);
                
                if (error.message.includes('CORS') || error.name === 'TypeError') {
                    showStatus('‚ùå CORS –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ - –Ω—É–∂–µ–Ω –ø—Ä–æ–∫—Å–∏', 'error');
                    items = [
                        { icon: 'üö´', text: 'CORS –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞' },
                        { icon: 'üîß', text: '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Vercel API' }
                    ];
                } else {
                    showStatus(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
                    items = [{ icon: '‚ùå', text: '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è' }];
                }
                
                startRotation();
            }
        }

        function processData(donations) {
            // –§–∏–ª—å—Ç—Ä—É–µ–º –¥–æ–Ω–∞—Ç—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –Ω–µ–¥–µ–ª—é
            const weekAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
            
            const recentDonations = donations.filter(d => {
                const date = new Date(d.created_at);
                return date.getTime() >= weekAgo;
            });

            console.log('üìÖ –î–æ–Ω–∞—Ç–æ–≤ –∑–∞ –Ω–µ–¥–µ–ª—é:', recentDonations.length);

            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
            const donors = {};
            
            recentDonations.forEach(d => {
                const name = d.username || '–ê–Ω–æ–Ω–∏–º';
                const amount = parseFloat(d.amount) || 0;
                const currency = d.currency || 'RUB';
                
                if (!donors[name]) {
                    donors[name] = { total: 0, currency: currency };
                }
                donors[name].total += amount;
            });

            // –°–æ–∑–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–ª—è –ø–æ–∫–∞–∑–∞
            items = Object.entries(donors)
                .sort(([,a], [,b]) => b.total - a.total)
                .map(([name, data]) => ({
                    icon: 'üí∞',
                    text: `${name} ‚Äî ${Math.round(data.total)} ${data.currency}`
                }));

            console.log('üë• –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –¥–æ–Ω–∞—Ç–µ—Ä–æ–≤:', items.length);

            if (items.length === 0) {
                items = [{ icon: '‚è≥', text: '–ù–µ—Ç –¥–æ–Ω–∞—Ç–æ–≤ –∑–∞ –Ω–µ–¥–µ–ª—é' }];
            }

            startRotation();
        }

        function startRotation() {
            if (intervalId) {
                clearInterval(intervalId);
            }

            if (items.length === 0) return;

            currentIndex = 0;
            showItem(0);

            if (items.length > 1) {
                intervalId = setInterval(() => {
                    currentIndex = (currentIndex + 1) % items.length;
                    showItem(currentIndex);
                }, 4000);
            }
        }

        function showItem(index) {
            if (!items[index]) return;

            const { icon, text } = items[index];
            const content = document.getElementById('content');
            const iconEl = content.querySelector('.icon');
            const textEl = content.querySelector('.text');

            console.log(`üì∫ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º: ${text}`);

            content.style.opacity = '0.5';
            
            setTimeout(() => {
                iconEl.textContent = icon;
                textEl.textContent = text;
                content.style.opacity = '1';
            }, 150);
        }

        function showStatus(message, type = '') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            
            console.log(`üìã –°—Ç–∞—Ç—É—Å: ${message}`);
        }

        // –°–æ–∑–¥–∞–µ–º URL –¥–ª—è OBS
        function generateObsUrl() {
            if (token && !isTestMode) {
                const url = new URL(window.location.href);
                url.searchParams.set('token', token);
                return url.toString();
            }
            return window.location.href;
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        window.getUrl = () => {
            const url = generateObsUrl();
            console.log('üîó URL –¥–ª—è OBS:', url);
            return url;
        };

        window.copyUrl = () => {
            const url = generateObsUrl();
            navigator.clipboard.writeText(url).then(() => {
                console.log('üìã URL —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
                showStatus('üìã URL —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω', 'success');
            });
        };

        console.log('üéÆ –í–∏–¥–∂–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω');
        console.log('üí° –ö–æ–º–∞–Ω–¥—ã: getUrl(), copyUrl()');
    </script>
</body>
</html>
